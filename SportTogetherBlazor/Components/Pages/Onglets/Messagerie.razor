@page "/SportTogether/Messagerie-instantane"
@using SportTogetherBlazor.Models
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory
@using SportTogetherBlazor.Services
@inject SessionStorageServices session
<div class="container">
    <div class="row clearfix">
        <div class="col-lg-4">
            <div class="card chat-app">
                <div id="plist" class="people-list">
                    <EditForm Model="@rechercheModel" OnSubmit="@RechercheSubmit" FormName="RechercheForm">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        <div class="form-group d-flex flex-row">
                            <InputText id="rechercheTitre" class="form-control"
                                       @bind-Value="rechercheModel.Titre" placeholder="Recherche..." />
                            <Button Type="ButtonType.Submit" Color="ButtonColor.Light" Size="Size.Medium" TooltipTitle="Rechercher">
                                <Icon Name="IconName.Search" />
                            </Button>
                        </div>
                    </EditForm>
                    <div class="list-group" id="list-tab" role="tablist">
                        @if (listGroupe.Any())
                        {
                            @foreach (Groupe groupe in listGroupe)
                            {
                                <a class="list-group-item list-group-item-action @(groupe == selectedGroupe ? "active" : "")"
                                   id="list-@groupe.Nom-list" @onclick="() => SelectGroupe(groupe)">
                                    <div class="card" >
                                        <div class="row no-gutters">
                                            <div class="col-sm-5">
                                                <img class="card-img img-fluid img-thumbnail" src="/images/@GetSportImageUrl((int)groupe.Annonce!.SportId!)" alt="groupe">
                                            </div>
                                            <div class="col-sm-7">
                                                <div class="card-body">
                                                    <h5 class="card-title">@groupe.Nom</h5>
                                                    <small>@groupe.LastMessage</small>
                                                    @if(groupe.nbreMessageVu != null)
                                                    {
                                                        <small><Badge Color="BadgeColor.Danger" Placement="BadgePlacement.MiddleRight">@groupe.nbreMessageVu</Badge></small>
                                                    }
                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                                
                            }
                        }
                        else
                        {
                            <p>Veuillez participer ou ajouter une annonce</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="chat">
                @if (selectedGroupe != null)
                {
                    <div class="chat-header clearfix">
                        <div class="row">
                            <div class="col-lg-6">
                                <h5 class="mb-0">@selectedGroupe.Nom</h5>
                            </div>
                        </div>
                    </div>
                    @if (listMessage != null && listMessage.Any())
                    {
                        <div class="chat-history position-relative">
                           
                                @foreach (var message in listMessage)
                                {
                                <div class="d-flex flex-row @((message.UtilisateurId == utilisateurID ? "justify-content-end" : "justify-content-start"))">
                                    <img src="@message.urlProfilImage" class="avatar">
                                    <div>
                                        <p class="small p-2 ms-3 mb-1 rounded-3 @((message.UtilisateurId == utilisateurID ? "bg-custom-user" : "bg-body-tertiary"))">
                                            @message.Contenu
                                        </p>
                                        <p class="small ms-3 mb-3 rounded-3 text-muted float-end">
                                            @message.Timestamp!.Value.ToString("HH:mm") | @message.NomUtilisateur
                                        </p>
                                    </div>
                                </div>

                                }
                           
                        </div>
                    }

                    <div class="chat-message clearfix position-absolute bottom-0 w-50" style="background-color: white; padding: 10px;">
                        <div class="input-group mb-0">
                            <InputText class="form-control" placeholder="Tapez votre message..." @bind-Value="nouveauMessage" />
                            <div class="input-group-append">
                                <Button Color="ButtonColor.Success" @onclick="EnvoyerMessage">Envoyer</Button>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-center">Veuillez sélectionner un groupe pour afficher les messages.</p>
                }
            </div>
        </div>
    </div>
</div>
<style>
    .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
    }

    .bg-custom-user {
        background-color: #49beb7; /* Couleur personnalisée pour les messages de l'utilisateur connecté */
        color: white; /* Texte blanc pour un meilleur contraste */
    }

    .bg-body-tertiary {
        background-color: #f1f1f1; /* Couleur de fond pour les autres messages */
        color: black; /* Texte noir */
    }

    .message-bubble {
        padding: 10px;
        border-radius: 15px;
        max-width: 400px; /* Limite la largeur des bulles de message */
        word-wrap: break-word; /* Pour que le texte reste à l'intérieur de la bulle */
    }

    .timestamp {
        font-size: 0.8rem;
        color: #6c757d; /* Couleur gris clair pour le timestamp */
    }

</style>
@code {
    private RechercheModel rechercheModel = new RechercheModel();
    private List<Groupe> listGroupe = new();
    private HttpClient httpClient;
    private int utilisateurID = 0;
    private Groupe selectedGroupe;
    private string nouveauMessage;
    private List<Message> listMessage;
    private string nomUtilisateur; 
    /// <summary>
    /// Initialisation de la page
    /// </summary>
    /// <returns></returns>
    protected override async Task OnInitializedAsync()
    {
        httpClient = HttpClientFactory.CreateClient("ApiSportTogetherClient");

        Utilisateur utilisateurInfo = session.GetUserFromSession()!;
        if (utilisateurInfo != null) { utilisateurID = utilisateurInfo.UtilisateursId;
            nomUtilisateur = utilisateurInfo.Pseudo!;
        }


        await GetGroupes();
        await GetMessages();
    }
    private async Task GetGroupes()
    {
        try
        {
            listGroupe = await httpClient.GetFromJsonAsync<List<Groupe>>($"Groupe/GetGroupePourMessagerie/{utilisateurID}")!;
            if (listGroupe.Any())
            {
                selectedGroupe = listGroupe.First();
                foreach (Groupe groupe in listGroupe)
                {
                    int? nbreVu = await GetNombreMessageVu(groupe.GroupesId);
                    if (nbreVu != null)
                    {
                        groupe.nbreMessageVu = nbreVu;
                    }

                }
            }
        }
        catch (Exception ex)
        {

        }

    } 
    private async Task<int?> GetNombreMessageVu(int groupeId)
    {
        try
        {
            int nbre = await httpClient.GetFromJsonAsync<int>($"GetVuMessagesCount/{groupeId}")!;
            return nbre;
        }
        catch (Exception ex)
        {
            return null;
        }



    }

    private async Task SelectGroupe(Groupe groupe)
    {
        selectedGroupe = groupe;
        if(listMessage != null)
            listMessage.Clear();
        await GetMessages(); // Charger les messages pour le groupe sélectionné
        StateHasChanged(); // Re-render the component
    }
    private async Task GetMessages()
    {
        try
        {
            listMessage = await httpClient.GetFromJsonAsync<List<Message>>($"Message/GetMessagesByGroupe/{selectedGroupe.GroupesId}")!;
        }catch(Exception ex)
        {

        }



    }
    private readonly Dictionary<int, (string color, string imageUrl)> sportStyles = new()
    {
        { 1, ("#6BDE2A", "ballon-foot.jpg") },
        { 2, ("#391E67", "basketball.jpg") },
        { 4, ("#6B1D4B", "tennis.jpg") },
        { 5, ("#D8AC2C", "athletisme.jpg") },
        { 6, ("#B36EDD", "gymnastique.jpg") },
        { 8, ("#CCF3DB", "natation.jpg") },
        { 9, ("#2C1707", "baseball.jpg") },
        { 10, ("#2A87FD", "cyclisme.jpg") },
        { 11, ("#C084BF", "volleyball.jpg") },
        { 12, ("#A78DA3", "rugby.jpg") },
        { 14, ("#A78DA3", "boxe.jpg") },
        { 15, ("#927584", "hockey.jpg") },
        { 16, ("#9A7C43", "tennis_table.jpg") },
        { 17, ("#033786", "badminton.jpg") },
        { 18, ("#6BDE2A", "poids-salles.jpg") },
        { 21, ("#391E67", "pétanque.jpg") },
        { 22, ("#6B1D4B", "yoga.jpg") },
    };

    /// <summary>
    ///
    /// </summary>
    /// <param name="sportId"></param>
    /// <returns></returns>
    private string GetSportColor(int sportId)
    {
        return sportStyles.ContainsKey(sportId) ? sportStyles[sportId].color : "#FFFFFF";
    }

    private async Task EnvoyerMessage()
    {
        if (!string.IsNullOrEmpty(nouveauMessage) && selectedGroupe != null)
        {
            Message message = new Message
                {
                    Contenu = nouveauMessage,
                    UtilisateurId = utilisateurID,
                    GroupeId = selectedGroupe.GroupesId,
                    Timestamp = DateTime.Now,
                    NomUtilisateur = nomUtilisateur
                };
            try
            {
                var client = HttpClientFactory.CreateClient("ApiSportTogetherClient");
                // Envoyer le message au serveur
                var response = await client.PostAsJsonAsync("Message/CreateMessage", message);
                if (response.IsSuccessStatusCode)
                {
                    // Ajouter le message à la liste des messages localement après un enregistrement réussi
                    var savedMessage = await response.Content.ReadFromJsonAsync<Message>();
                    listMessage.Add(savedMessage);

                    // Mettre à jour l'affichage
                    StateHasChanged();
                }
                else
                {
                    // Gérer l'erreur si l'envoi échoue
                    Console.WriteLine("Erreur lors de l'envoi du message.");
                }

                // Réinitialiser le champ de saisie
                nouveauMessage = string.Empty;
            }catch(Exception ex)
            {
                
            }
           

            
        }
    }


    private async Task RechercheSubmit()
    {
        // if (!string.IsNullOrWhiteSpace(rechercheModel.Titre))
        // {
        //     if (!bFirstFiltreAnnonces)
        //     {
        //         try
        //         {
        //             annonces.Clear();
        //             PreloadService.Show(SpinnerColor.Light, "Recherche en cours...");
        //             annonces = ((await Http.GetFromJsonAsync<List<AnnonceVue>>($"/vue/titre/{rechercheModel.Titre}/{genreUtilisateur}/{villeUtilisateur}"))!);
        //             PreloadService.Hide();
        //             StateHasChanged();
        //         }
        //         catch (Exception ex)
        //         {
        //             PreloadService.Hide();
        //             Console.WriteLine($"Exception lors de l'appel API: {ex.Message}");
        //         }
        //     }
        // }
        // else
        // {
        //     await LoadAnnonces();
        // }
    }

    /// <summary>
    ///
    /// </summary>
    /// <param name="sportId"></param>
    /// <returns></returns>
    private string GetSportImageUrl(int sportId)
    {
        return sportStyles.ContainsKey(sportId) ? sportStyles[sportId].imageUrl : "default.jpg";
    }
    public class RechercheModel
    {
        public string Titre { get; set; } = string.Empty;
    }
}
