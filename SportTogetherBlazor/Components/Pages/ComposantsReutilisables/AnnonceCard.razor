@using SportTogetherBlazor.Models
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory


<div class="card shadow p-3 position-relative" style="background-color #f1f1f1; background-size:cover; color: #34495e; border-color:@GetSportColor((int)annonceVue.SportId!); border-width:medium;">
   
   
    <div class="card-header bg-transparent">
        <h3 class="text-center">@annonceVue.Titre</h3>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4">
                    <img class="img-fluid rounded-start" src="/images/@GetSportImageUrl((int)annonceVue.SportId!)" alt="image de sport">
                </div>
                <div class="col-md-8 text-center">
                    <div class="d-flex align-items-center justify-content-center">
                        <ProfilVueUtilisateurCard Auteur="@annonceVue.Auteur" userId="@annonceVue.AuteurId" sport="@annonceVue.SportName"/> 
                    </div>
                    <hr class="my-2" />
                    <div class="d-flex align-items-center justify-content-center">
                        <Icon Name="IconName.PinMap" Size="IconSize.x4" class="me-1" Style="color:#34495e"></Icon>
                        <p class="m-0">@annonceVue.Ville</p>
                    </div>
                    <hr class="my-2" />
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <Icon Name="IconName.GenderAmbiguous" Style="color:#34495e" Size="IconSize.x4" class="me-1"></Icon>
                        <p class="m-0">@annonceVue.GenreAttendu</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <details class="accordion">
            <summary>Plus de détails</summary>
            <p class="card-text">La description : @annonceVue.Description</p>
            <p class="card-text">Lieu : @annonceVue.Lieu</p>
        </details>
    </div>
    <div class="card-footer bg-transparent">
        <p> Le @annonceVue.DateHeureAnnonce.ToString("dd/MM/yyyy") à @annonceVue.DateHeureAnnonce.ToString("HH:mm")</p>
        <div class="d-flex justify-content-between align-items-center">
            <p class="m-0">Nombre de participants : @nombreDeParticipants / @annonceVue.NombreParticipants</p>
            @if (!isAuteur)
            {
                @if (isParticipant)
                {
                    <Button Color="ButtonColor.Danger" @onclick="ShowRemoveParticipationModal" TooltipTitle="Se désinscrire">
                        <Icon Name="IconName.X" Size="IconSize.x4"></Icon>
                    </Button>
                }
                else
                {
                    <Button Color="ButtonColor.Success" @onclick="ShowAddParticipationModal" TooltipTitle="Participer">
                        <Icon Name="IconName.Check" Size="IconSize.x4"></Icon>
                    </Button>
                }
            }
            
        </div>
    </div>
</div>

<Modal @ref="addParticipationModal" title="Confirmer la participation" IsVerticallyCentered="true">
    <BodyTemplate>
        <p>Voulez-vous vraiment participer à l'annonce '@annonceVue.Titre' ?</p>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="HideAddParticipationModal">Annuler</Button>
        <Button Color="ButtonColor.Success" @onclick="AddParticipation">Confirmer</Button>
    </FooterTemplate>
</Modal>

<Modal @ref="removeParticipationModal" title="Confirmer la désinscription" IsVerticallyCentered="true">
    <BodyTemplate>
        <p>Voulez-vous vraiment vous désinscrire de l'annonce '@annonceVue.Titre' ?</p>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="HideRemoveParticipationModal">Annuler</Button>
        <Button Color="ButtonColor.Danger" @onclick="RemoveParticipation">Confirmer</Button>
    </FooterTemplate>
</Modal>


<!-- ProfileViewModal Component -->

<style>
    .badge {
        font-size: 14px;
        font-weight: bold;
        color: white;
        z-index: 1;
    }
</style>
@code {
    [Parameter]
    public AnnonceVue annonceVue { get; set; }
    [Parameter]
    public int utilisateur { get; set; }
    private int nombreDeParticipants;
    [Inject] protected ToastService ToastService { get; set; } = default!;
    private bool isParticipant = false;
    private HttpClient httpClient;
    private bool isAuteur = false;
    private Modal addParticipationModal = default!;
    private Modal removeParticipationModal = default!;


    /// <summary>
    /// Initialisation de la page
    /// </summary>
    /// <returns></returns>
    protected override async Task OnInitializedAsync()
    {
        httpClient = HttpClientFactory.CreateClient("ApiSportTogetherClient");
        nombreDeParticipants = await httpClient.GetFromJsonAsync<int>($"Participation/Annonce/{annonceVue.AnnoncesId}/count");
        isParticipant = await CheckIfParticipant();
        if(annonceVue.AuteurId == utilisateur)
        {
            isAuteur = true;
        }

    }

    /// <summary>
    /// Ajout d'un participant
    /// </summary>
    /// <returns></returns>
    private async Task ShowAddParticipationModal()
    {
        await addParticipationModal.ShowAsync();
    }

    /// <summary>
    /// Cache le boutton d'ajout de participant
    /// </summary>
    /// <returns></returns>
    private async Task HideAddParticipationModal()
    {
        await addParticipationModal.HideAsync();
    }

    /// <summary>
    /// Affiche le btton se déconnecter
    /// </summary>
    /// <returns></returns>
    private async Task ShowRemoveParticipationModal()
    {
        await removeParticipationModal.ShowAsync();
    }

    /// <summary>
    /// Cache le button se déconnecter
    /// </summary>
    /// <returns></returns>
    private async Task HideRemoveParticipationModal()
    {
        await removeParticipationModal.HideAsync();
    }

    /// <summary>
    /// Fonction d'ajout de participant
    /// </summary>
    /// <returns></returns>
    private async Task AddParticipation()
    {
        await HideAddParticipationModal();

        Participation participation = new Participation
            {
                AnnonceId = annonceVue.AnnoncesId,
                UtilisateurId = utilisateur,
                DateParticipation = DateTime.Now
            };

        var response = await httpClient.PostAsJsonAsync("Participation/CreateParticipation", participation);
        if (response.IsSuccessStatusCode)
        {
            nombreDeParticipants++;
            ToastService.Notify(new(ToastType.Success, $"Votre participation à l'annonce '{annonceVue.Titre}' est bien enregistrée"));
            isParticipant = true;
            StateHasChanged();
        }
        else
        {
            var errorMessage = await response.Content.ReadAsStringAsync();
            ToastService.Notify(new(ToastType.Danger, $"Votre participation à l'annonce '{annonceVue.Titre}' n'a pas pu s'enregistrer. Veuillez réessayer."));
        }
    }

    /// <summary>
    /// Fonction de suppression de participant
    /// </summary>
    /// <returns></returns>
    private async Task RemoveParticipation()
    {
        await HideRemoveParticipationModal();

        Participation participation = new Participation
            {
                AnnonceId = annonceVue.AnnoncesId,
                UtilisateurId = utilisateur
            };

        var response = await httpClient.PostAsJsonAsync("Participation/DeleteParticipation", participation);
        if (response.IsSuccessStatusCode)
        {
            nombreDeParticipants--;
            isParticipant = false;
            ToastService.Notify(new(ToastType.Success, $"Participation pour l'annonce '{annonceVue.Titre}' retirée avec succès !"));
            StateHasChanged();
        }
        else
        {
            var errorMessage = await response.Content.ReadAsStringAsync();
            ToastService.Notify(new(ToastType.Danger, $"Erreur lors du retrait de la participation : {errorMessage}"));
        }
    }

    /// <summary>
    /// Check si il y a un participant
    /// </summary>
    /// <returns></returns>
    private async Task<bool> CheckIfParticipant()
    {
        var participe = await httpClient.GetFromJsonAsync<bool>($"Participation/CheckParticipation/{utilisateur}/{annonceVue.AnnoncesId}");
        return participe;
    }

    private readonly Dictionary<int, (string color, string imageUrl)> sportStyles = new()
    {
        { 1, ("#bfd960", "ballon-foot.jpg") },
        { 2, ("#391E67", "basketball.jpg") },
        { 4, ("#6B1D4B", "tennis.jpg") },
        { 5, ("#D8AC2C", "athletisme.jpg") },
        { 6, ("#B36EDD", "gymnastique.jpg") },
        { 8, ("#CCF3DB", "natation.jpg") },
        { 9, ("#2C1707", "baseball.jpg") },
        { 10, ("#2A87FD", "cyclisme.jpg") },
        { 11, ("#C084BF", "volleyball.jpg") },
        { 12, ("#A78DA3", "rugby.jpg") },
        { 14, ("#A78DA3", "boxe.jpg") },
        { 15, ("#927584", "hockey.jpg") },
        { 16, ("#9A7C43", "tennis_table.jpg") },
        { 17, ("#033786", "badminton.jpg") },
        { 18, ("#6BDE2A", "poids-salles.jpg") },
        { 21, ("#391E67", "pétanque.jpg") },
        { 22, ("#6B1D4B", "yoga.jpg") },
    };

    /// <summary>
    /// 
    /// </summary>
    /// <param name="sportId"></param>
    /// <returns></returns>
    private string GetSportColor(int sportId)
    {
        return sportStyles.ContainsKey(sportId) ? sportStyles[sportId].color : "#FFFFFF";
    }


    /// <summary>
    /// 
    /// </summary>
    /// <param name="sportId"></param>
    /// <returns></returns>
    private string GetSportImageUrl(int sportId)
    {
        return sportStyles.ContainsKey(sportId) ? sportStyles[sportId].imageUrl : "default.jpg";
    }
}
